<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Seagold AR Business Card</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="mindar/mindar-image-aframe.prod.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Floating Map -->
    <div id="map-overlay" class="map-overlay">
      <div id="map"></div>
    </div>

    <a-scene mindar-image="imageTargetSrc: assets/back.mind; autoStart: true; uiScanning: true; wasmPath: ./mindar/"
             embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
             device-orientation-permission-ui="enabled: true">
      <a-camera position="0 0 0"></a-camera>
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="map-anchor" position="0 0 0" width="1" height="0.5" color="#00FFAA"></a-plane>
      </a-entity>
    </a-scene>

    <script>
      document.querySelector('.mindar-ui-overlay .scanning')?.insertAdjacentHTML('beforeend', '<div style="margin-top: 12px; color: white;">Scan your card</div>');

      const mapOverlay = document.getElementById("map-overlay");
      const mapDiv = document.getElementById("map");
      const anchor = document.getElementById("map-anchor");

      document.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector("a-scene");

        scene.addEventListener("arReady", () => {
          console.log("âœ… AR is ready");
        });

        scene.addEventListener("targetFound", () => {
          console.log("ðŸŽ¯ Target found!");
          mapOverlay.classList.add("show");

          if (window.mapInitialized) return;
          window.mapInitialized = true;

          navigator.geolocation.getCurrentPosition((position) => {
            const userPos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            const dormPos = {
              lat: 14.603919,
              lng: 120.987760,
            };

            const map = new google.maps.Map(mapDiv, {
              zoom: 15,
              center: userPos,
            });

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
              suppressMarkers: true,
            });
            directionsRenderer.setMap(map);

            directionsService.route(
              {
                origin: userPos,
                destination: dormPos,
                travelMode: google.maps.TravelMode.WALKING,
              },
              (response, status) => {
                if (status === "OK") {
                  directionsRenderer.setDirections(response);
                } else {
                  console.error("Directions request failed:", status);
                }
              }
            );

            new google.maps.Marker({
              position: dormPos,
              map: map,
              title: "Seagold Dormitory",
              icon: {
                url: "seagoldpinicon.png",
                scaledSize: new google.maps.Size(65, 50),
              },
            });

            new google.maps.Marker({
              position: userPos,
              map: map,
              title: "You are here",
              icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                scaledSize: new google.maps.Size(40, 40),
              },
            });
          });
        });

        scene.addEventListener("targetLost", () => {
          console.log("ðŸ‘‹ Target lost!");
          mapOverlay.classList.remove("show");
        });

        // Map follows anchor (just like Zappar)
        scene.addEventListener("loaded", () => {
          scene.renderer.xr.addEventListener("sessionstart", () => {
            const update = () => {
              if (!anchor || !anchor.object3D || !scene.camera) {
                requestAnimationFrame(update);
                return;
              }

              const worldPos = new THREE.Vector3();
              anchor.object3D.getWorldPosition(worldPos);

              const cam = scene.camera;
              const width = scene.renderer.domElement.width;
              const height = scene.renderer.domElement.height;

              const projected = worldPos.clone().project(cam);
              const x = (projected.x * 0.5 + 0.5) * width;
              const y = (1 - (projected.y * 0.5 + 0.5)) * height;

              mapOverlay.style.left = `${x - 200}px`;
              mapOverlay.style.top = `${y - 150}px`;

              requestAnimationFrame(update);
            };

            update();
          });
        });
      });
    </script>
  </body>
</html>
