<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Seagold AR Business Card</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="mindar/mindar-image-aframe.prod.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: assets/back.mind; autoStart: true; uiScanning: true; wasmPath: ./mindar/"
             embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
             device-orientation-permission-ui="enabled: true">
      <a-camera position="0 0 0"></a-camera>

      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <!-- Card base -->
        <a-plane position="0 0 0" width="1" height="0.5" color="#00FFAA"></a-plane>

        <!-- Placeholder for map -->
        <a-plane id="mapPlane" position="0.35 0.15 0.01" width="0.5" height="0.3" color="#ddd"></a-plane>
      </a-entity>
    </a-scene>

    <script>
      const mapPlane = document.getElementById("mapPlane");

      // Scan instruction text
      document.querySelector('.mindar-ui-overlay .scanning')?.insertAdjacentHTML(
        'beforeend',
        '<div style="margin-top: 12px; color: white;">Scan your card</div>'
      );

      // Replace this with your own key if needed
      const GOOGLE_API_KEY = "AIzaSyBoAmNMyi-pULIdPSAjDMbRsrHMWeXLLrE";
      const dormPos = { lat: 14.603919, lng: 120.987760 };

      function encodeLatLngs(path) {
        // This helper function converts lat/lng points to encoded polyline format
        // But we donâ€™t need to manually encode, we can use Google Directions API's `overview_polyline.points`
        return path; // placeholder
      }

      function createStaticMapUrl(userPos, encodedPath) {
        const size = "512x512";
        const markers = [
          `color:blue|${userPos.lat},${userPos.lng}`,
          `icon:https://upload.wikimedia.org/wikipedia/commons/6/65/Google_Maps_pin.svg|${dormPos.lat},${dormPos.lng}`
        ];
        return `https://maps.googleapis.com/maps/api/staticmap?size=${size}&scale=2&maptype=roadmap&path=enc:${encodedPath}&markers=${markers.join("&markers=")}&key=${GOOGLE_API_KEY}`;
      }

      function setMapTexture(url) {
        mapPlane.setAttribute("material", "src", url);
      }

      navigator.geolocation.getCurrentPosition((position) => {
        const userPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        const directionsUrl = `https://maps.googleapis.com/maps/api/directions/json?origin=${userPos.lat},${userPos.lng}&destination=${dormPos.lat},${dormPos.lng}&mode=walking&key=${GOOGLE_API_KEY}`;

        // Use a CORS proxy (like corsproxy.io) since the Google Directions API doesn't allow client-side requests directly
        fetch(`https://corsproxy.io/?${encodeURIComponent(directionsUrl)}`)
          .then(res => res.json())
          .then(data => {
            const encodedPolyline = data.routes[0].overview_polyline.points;
            const staticMapUrl = createStaticMapUrl(userPos, encodedPolyline);
            setMapTexture(staticMapUrl);
          })
          .catch(err => {
            console.error("Failed to fetch directions:", err);
          });
      }, (err) => {
        console.error("Geolocation error:", err);
      });
    </script>
  </body>
</html>
